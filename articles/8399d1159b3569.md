---
title: "ã€JavaScriptã€‘é¸æŠžç¯„å›²ã®çµ‚ç‚¹åº§æ¨™ã®å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹"
emoji: "ðŸ”š"
type: "tech"
topics: ["javascript"]
published: true
---

# ç›®çš„

`input`, `textarea` ä»¥å¤–ã®è¦ç´ ã«ãŠã„ã¦ã€ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã®ä½ç½®ã«ç›¸å½“ã™ã‚‹åº§æ¨™ã‚’å¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«å–å¾—ã—ãŸã„ã€‚

# æ–¹æ³•

```js
document.addEventListener('selectionchange', () => {
  const selection = getSelection()
  const rangeCount = selection.rangeCount
  if (rangeCount === 0) {
    return
  }
  // è¤‡æ•°é¸æŠžã‚’é˜²ã â€“ Firefox (Gecko)
  if (rangeCount > 1) {
    for (let i = 1; i < rangeCount; i++) {
      selection.removeRange(selection.getRangeAt(i))
    }
  }
  const caretRange = document.createRange()
  const focusNode = selection.focusNode
  const focusOffset = selection.focusOffset
  caretRange.setStart(focusNode, focusOffset)
  caretRange.setEnd(focusNode, focusOffset)
  const caretRect = caretRange.getBoundingClientRect()
  console.log(caretRect.x, caretRect.y)
})
```

# è§£èª¬

`selection` ã® `focus` ã¯é¸æŠžç¯„å›²ã®çµ‚ç‚¹ã‚’å«ã‚€ `node` ã®æƒ…å ±ã‚’è¿”ã—ã¾ã™ã€‚

```
é¸æŠžæ–¹å‘ (->, <-)
é¸æŠžç¯„å›² (||)
```

```
           |------>|
TextNode ( | h | e | l | l | o | )
           0   1   2   3   4   5

focusNode: TextNode
focusOffset: 2
```

```
               |<------|
TextNode ( | h | e | l | l | o | )
           0   1   2   3   4   5

focusNode: TextNode
focusOffset: 1
```

ãã®æƒ…å ±ã‚’åŸºã«ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã®ç¯„å›²ã¨ãªã‚‹ `range` ã‚’ä½œã‚‹ã“ã¨ã§çµ‚ç‚¹åº§æ¨™ã‚’å–å¾—ã§ãã¾ã™ã€‚

```js
// range ä½œæˆ
const caretRange = document.createRange()

// selection ã® focus ã‚’å–å¾—
const focusNode = selection.focusNode
const focusOffset = selection.focusOffset

// focus ã®æƒ…å ±ã‚’ range ã«ã‚»ãƒƒãƒˆ
caretRange.setStart(focusNode, focusOffset)
caretRange.setEnd(focusNode, focusOffset)

// range ã®åº§æ¨™ã‚’å–å¾— ðŸŽ‰
const caretRect = caretRange.getBoundingClientRect()
console.log(caretRect.x, caretRect.y)
```

# æ³¨æ„äº‹é …

- å–å¾—ã—ãŸåº§æ¨™ã«å¸¸ã«å¼µã‚Šä»˜ãã‚ˆã†ãªè¦ç´ ã‚’ä½œã‚‹ã¨ç¯„å›²é¸æŠžã«å½±éŸ¿ãŒå‡ºã¦ã—ã¾ã†ã€‚

:::message
è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã« `user-select: none;` ã¨ `pointer-events: none` ã‚’é©ç”¨ã™ã‚‹ã€‚
å…¨é¸æŠžæ™‚ã¨ãƒžã‚¦ã‚¹æ“ä½œæ™‚ã®å•é¡ŒãŒã“ã‚Œã§è§£æ±ºã—ã¾ã™ã€‚
:::

- å…¨é¸æŠžæ™‚ã€`body` ã®ç›´ä¸‹ã®æœ€åˆã‹æœ€å¾Œã« `input`, `textarea` ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«å§‹ç‚¹ã‹çµ‚ç‚¹ã®å¯¾è±¡è¦ç´ ãŒ `body` ã«ãªã£ã¦ã—ã¾ã„æ­£ã—ã„åº§æ¨™ãŒå–å¾—ã§ããªã„ã€‚

:::message
ã‚¹ã‚¿ã‚¤ãƒ«ã« `user-select: none;` ã‚’é©ç”¨ã—ãŸè¦ç´ ã§ `input`, `textarea` ã‚’åŒ…ã‚€ã¨è§£æ±ºã—ã¾ã™ã€‚
:::

- å…¨é¸æŠžæ™‚ã€`body` ã®æœ€åˆã‹æœ€å¾Œã« `contenteditable="true"` ã®è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ä½ç½®ãŒæœ€åˆãªã‚‰ `anchor` ã®å€¤ãŒ `focus` ã«ã€æœ€å¾Œãªã‚‰ `focus` ã®å€¤ãŒ `anchor` ã¨åŒã˜ã‚‚ã®ã«ãªã£ã¦ã—ã¾ã†ã€‚

:::message
JavaScript ã§ `selection` ã«æ­£ã—ã„å€¤ã‚’è¨­å®šã—ç›´ã™ã€‚
åŽŸç†ãŒåˆ†ã‹ã‚‰ãªã„ã®ã§å¯¾ç—‡ç™‚æ³•ã§ã™ã€‚
:::

# end
