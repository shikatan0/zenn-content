---
title: "F# - HTTP ã§ Google Drive API ã‚’åˆ©ç”¨ã™ã‚‹"
emoji: "ğŸ“"
type: "tech"
topics: ["dotnet", "fsharp", "googledrive"]
published: true
---

# åºæ–‡

Google Drive API ã® .NET ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª [Google.Apis.Drive.v3 [â†—]](https://www.nuget.org/packages/Google.Apis.Drive.v3/) ã« [uploadType [â†—]](https://developers.google.com/drive/api/v3/manage-uploads) ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ãŒè¦‹å½“ãŸã‚‰ãªã‹ã£ãŸã®ã§ HTTP ã‹ã‚‰ç›´æ¥åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

# æ¦‚è¦

- F# ã§ **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³** ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã®ç´¹ä»‹ã€‚

# äº‹å‰æº–å‚™

1. Drive APIã€Docs API ãŒæœ‰åŠ¹ãª Google Cloud Platform ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã™ã‚‹ [[â†—]](https://developers.google.com/workspace/guides/create-project)ã€‚
2. èªè¨¼æƒ…å ±ã‚’ä½œã‚‹ [[â†—]](https://developers.google.com/workspace/guides/create-credentials)ã€‚

# èªå¯ã‚³ãƒ¼ãƒ‰ã®å–å¾—

:::message
æ¬¡ã®é …ç›®ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
:::

```
https://accounts.google.com/o/oauth2/v2/auth?
response_type=code&client_id=ğŸ£
&redirect_uri=urn:ietf:wg:oauth:2.0:oob&
scope=https://www.googleapis.com/auth/drive&access_type=offline
```

1. URL ã® `ğŸ£` ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã«æ›¸ãæ›ãˆã‚‹ã€‚
2. URL ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€‚
3. é–‹ã„ãŸãƒšãƒ¼ã‚¸ã‚’é€²ã‚ã‚‹ã¨èªå¯ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

# ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—

:::message
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç´„1æ™‚é–“ã§æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã™ã€‚
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¹°ã‚Šè¿”ã—å–å¾—ã™ã‚‹ã«ã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚
:::

```fsharp:RefreshToken.fsx
let bodyJson =
    """{
        "client_id": "ğŸ£",
        "client_secret": "ğŸ˜",
        "grant_type": "authorization_code",
        "code": "ğŸ¦‘",
        "redirect_uri": "urn:ietf:wg:oauth:2.0:oob",
        "access_type": "offline"
    }"""

let content =
    new System.Net.Http.StringContent(
        bodyJson,
        System.Text.Encoding.UTF8,
        @"application/json"
    )

let request =
    new System.Net.Http.HttpRequestMessage(
        System.Net.Http.HttpMethod.Post,
        "https://www.googleapis.com/oauth2/v4/token",
        Content = content
    )

let client = new System.Net.Http.HttpClient()
let response = client.Send(request)
client.Dispose()

printfn "%s"
<| response.Content.ReadAsStringAsync().Result
```

1. `RefreshToken.fsx` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€‚
2. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®çµµæ–‡å­—ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

|è¨˜å·|æ›¸ãæ›ãˆå…ˆ|
|:-:|:-:|
|`ğŸ£`|ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID|
|`ğŸ˜`|ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ|
|`ğŸ¦‘`|èªå¯ã‚³ãƒ¼ãƒ‰|

3. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```powershell:PowerShell
dotnet fsi RefreshToken.fsx
```

4. å‡ºåŠ›ã•ã‚ŒãŸ JSON ã® `"refresh_token"` ã®å€¤ã‚’è¨˜éŒ²ã™ã‚‹ã€‚

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—

:::message
Google Drive API ã®ä½¿ç”¨æ™‚ã«å¿…è¦ã§ã™ã€‚
:::

```fsharp:Program.fs
let regex =
    new System.Text.RegularExpressions.Regex(
        @"^{\n  ""access_token"": ""(.*?)""",
        System.Text.RegularExpressions.RegexOptions.Compiled
    )

let bodyJson =
    """{
        "client_id": "ğŸ£",
        "client_secret": "ğŸ˜",
        "grant_type": "refresh_token",
        "refresh_token": "ğŸ"
    }"""

let refresh () =
    let content =
        new System.Net.Http.StringContent(
            bodyJson,
            System.Text.Encoding.UTF8,
            @"application/json"
        )

    let request =
        new System.Net.Http.HttpRequestMessage(
            System.Net.Http.HttpMethod.Post,
            "https://www.googleapis.com/oauth2/v4/token",
            Content = content
        )

    let client = new System.Net.Http.HttpClient()
    let response = client.Send(request)
    client.Dispose()

    if response.IsSuccessStatusCode then
        let resultJson = response.Content.ReadAsStringAsync().Result
        let accessToken = regex.Match(resultJson).Groups.[1].Value
        Some(accessToken)
    else
        None
```

:::message alert
JSON ã‚’ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›ã™ã‚‹æ–¹æ³•ã¯ [FSharp.Data [â†—]](https://www.nuget.org/packages/FSharp.Data) ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
:::

1. `Program.fs` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€‚
2. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®çµµæ–‡å­—ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

|è¨˜å·|æ›¸ãæ›ãˆå…ˆ|
|:-:|:-:|
|`ğŸ£`|ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID|
|`ğŸ˜`|ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ|
|`ğŸ`|ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³|

## ä½¿ç”¨ä¾‹

- ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹é–¢æ•° `createFolder`ã€‚
- å¤±æ•—æ™‚ã«å‰ã®é …ç›®ã§ä½œã£ãŸ `refresh` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€‚

```fsharp:Program.fs
let mutable accessToken = ""

let rec createFolder name =
    let bodyJson =
        $"""{{
            "mimeType": "application/vnd.google-apps.folder",
            "name": "{name}"
        }}"""

    let content =
        new System.Net.Http.StringContent(
            bodyJson,
            System.Text.Encoding.UTF8,
            @"application/json"
        )

    let parameters = "uploadType=multipart"

    let request =
        new System.Net.Http.HttpRequestMessage(
            System.Net.Http.HttpMethod.Post,
            $"https://www.googleapis.com/drive/v3/files?{parameters}",
            Content = content
        )

    request.Headers.Add("Authorization", $"Bearer {accessToken}")

    let client = new System.Net.Http.HttpClient()
    let response = client.Send(request)
    client.Dispose()

    if not response.IsSuccessStatusCode then
        let newToken = refresh()
        if newToken.IsSome then
            accessToken <- newToken.Value
            createFolder name
```

# é–¢é€£è¨˜äº‹

- [.NET 5, F# - Google Drive API Quickstart +Î± [â†—]](https://zenn.dev/shikatan/articles/6009f0f32358f55c1e76)

# end