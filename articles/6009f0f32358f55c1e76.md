---
title: ".NET 5, F# - Google Drive API Quickstart +Î±"
emoji: "ğŸ“"
type: "tech"
topics: ["dotnet", "fsharp", "googledrive"]
published: true
---

# æ¦‚è¦

.NET 5ã€F# ã§ Google Drive API å…¥é–€ã€‚

# äº‹å‰æº–å‚™

1. Drive API ãŒæœ‰åŠ¹ãª Google Cloud Platform ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã™ã‚‹ [[â†—]](https://developers.google.com/workspace/guides/create-project)ã€‚
2. `credentials.json` ã‚’ä½œã‚‹ [[â†—]](https://developers.google.com/workspace/guides/create-credentials)ã€‚

# ç’°å¢ƒ

- [Visual Studio Code [â†—]](https://code.visualstudio.com/)
- [.NET SDK 5.0 [â†—]](https://dotnet.microsoft.com/download)

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆ

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

```powershell
dotnet new console -lang "F#" -o å ´æ‰€\ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
```

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã™ã‚‹

Visual Studio Code ã§ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ« (Ctrl + `) ã§ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚

```powershell
dotnet add package Google.Apis.Drive.v3
```

## `credentials.json` ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®ç›´ä¸‹ã« `credentials.json` ã‚’é…ç½®ã€‚

```diff
  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
   â”œâ”€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ.fsproj
   â”œâ”€ Program.fs
+  â””â”€ credentials.json
```

`.fsproj` ã« `credentials.json` ã‚’ `bin\Debug\net5.0` ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹è¨­å®šã‚’è¿½è¨˜ã™ã‚‹ã€‚

```diff xml:.fsproj
    <ItemGroup>
+     <Content Include="credentials.json">
+       <CopyToOutputDirectory>Always</CopyToOutputDirectory>
+     </Content>
      <Compile Include="Program.fs" />
    </ItemGroup>
```

## `Program.fs` ã‚’å¤‰æ›´ã™ã‚‹

[.NET quickstart (C#) [â†—]](https://developers.google.com/drive/api/v3/quickstart/dotnet) ã‚’æ”¹å¤‰ã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚
å¤‰æ•° `driveService` ã‹ã‚‰ Google Drive API ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```fsharp:Program.fs
let Scopes = [|
    Google.Apis.Drive.v3.DriveService.Scope.Drive
|]

let ApplicationName = "Drive API F# Quickstart"

let fileStream = new System.IO.FileStream("credentials.json", System.IO.FileMode.Open, System.IO.FileAccess.Read)
let clientSecrets = Google.Apis.Auth.OAuth2.GoogleClientSecrets.Load(fileStream).Secrets
fileStream.Dispose()
let cancellationToken = System.Threading.CancellationToken.None
let fileDataStore = new Google.Apis.Util.Store.FileDataStore("token.json", true)
let userCredential = Google.Apis.Auth.OAuth2.GoogleWebAuthorizationBroker.AuthorizeAsync(clientSecrets, Scopes, "user", cancellationToken, fileDataStore).Result

let initializer = new Google.Apis.Services.BaseClientService.Initializer()
initializer.ApplicationName <- ApplicationName
initializer.HttpClientInitializer <- userCredential

let driveService = new Google.Apis.Drive.v3.DriveService(initializer)
```

### `Scopes`

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒåˆ©ç”¨ã™ã‚‹æ©Ÿèƒ½ ([å€¤ã®ä¸€è¦§ [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.DriveService.Scope.html))ã€‚

# Google Drive

Google Drive API ã‚’ä½¿ã†ä¸Šã§å¿…è¦ã«ãªã‚‹çŸ¥è­˜ã€‚

## ID

[Google Drive [â†—]](https://drive.google.com/) ã®ã€Œãƒªãƒ³ã‚¯ã‚’å–å¾—ã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

|ç¨®é¡|ID|
|:-:|:-:|
|ãƒ•ã‚¡ã‚¤ãƒ«|`https://drive.google.com/file/d/` **ã‚³ã‚³** `/view?usp=sharing`|
|ãƒ•ã‚©ãƒ«ãƒ€|`https://drive.google.com/drive/folders/` **ã‚³ã‚³** `?usp=sharing`|
|ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–|**root**|

# Google.Apis.Drive.v3

- [ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.html)
- [Drive API [â†—]](https://developers.google.com/drive/api/v3/about-sdk)

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã®å–å¾—

- [Files.Get [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Get_System_String_)

```fsharp
let getRequest = driveService.Files.Get("å¯¾è±¡ã® ID")
// ...
let itemData = getRequest.Execute()
```

### -- å–å¾—ã™ã‚‹æƒ…å ±ã®è¨­å®š

- [Fields [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.DriveBaseServiceRequest-1.html#Google_Apis_Drive_v3_DriveBaseServiceRequest_1_Fields)
- [files ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ [â†—]](https://developers.google.com/drive/api/v3/reference/files)

```fsharp
getRequest.Fields <- "nextPageToken, files(name, id)"
```

- [å–å¾—æ™‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.Data.File.html)

```fsharp
printfn "%s" itemData.Name
printfn "%s" itemData.Id
```

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã®æ¤œç´¢

- [Files.List [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_List)

```fsharp
let listRequest = driveService.Files.List()
// ...
let itemList = listRequest.Execute()
```

### -- æ¤œç´¢ã®æ¡ä»¶

- [Q [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.ListRequest.html#Google_Apis_Drive_v3_FilesResource_ListRequest_Q)
- [æ¤œç´¢ã‚¯ã‚¨ãƒªã®æ§‹æ–‡ [â†—]](https://developers.google.com/drive/api/v3/reference/query-ref)

```fsharp
listRequest.Q <- "('root' in parents) and (trashed = false)"
```

#### ãƒ•ã‚¡ã‚¤ãƒ«é™å®š

```fsharp
listRequest.Q <- "mimeType != 'application/vnd.google-apps.folder'"
```

#### ãƒ•ã‚©ãƒ«ãƒ€é™å®š

```fsharp
listRequest.Q <- "mimeType = 'application/vnd.google-apps.folder'"
```

### -- å–å¾—ã™ã‚‹æƒ…å ±ã®è¨­å®š

- [Fields [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.DriveBaseServiceRequest-1.html#Google_Apis_Drive_v3_DriveBaseServiceRequest_1_Fields)
- [files ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ [â†—]](https://developers.google.com/drive/api/v3/reference/files)

```fsharp
listRequest.Fields <- "nextPageToken, files(name, id)"
```

- [å–å¾—æ™‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.Data.File.html)

```fsharp
let listRequest = driveService.Files.List()
listRequest.Fields <- "nextPageToken, files(name, id)"
let itemList = listRequest.Execute()
let itemData = itemList.Files.[0]

printfn "%s" itemData.Name
printfn "%s" itemData.Id
```

### -- 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€æ•°

- è¦å®šå€¤: 100
- æœ€å¤§å€¤: 1000

```fsharp
listRequest.pageSize <- 1
```

### -- å–å¾—ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã®ç®¡ç†

- `PageToken`: æ¤œç´¢ã™ã‚‹ãƒšãƒ¼ã‚¸
- `nextPageToken`: æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ã™æ–‡å­—åˆ—

```fsharp
let listRequest = driveService.Files.List()
listRequest.Fields <- "nextPageToken, files(name, id)"
let mutable itemList = listRequest.Execute()

while itemList.NextPageToken <> null do
    let listRequest = driveService.Files.List()
    listRequest.Fields <- "nextPageToken, files(name, id)"
    listRequest.PageToken <- itemList.NextPageToken
    itemList <- listRequest.Execute()
```

## ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ

- [Files.Create [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Create_Google_Apis_Drive_v3_Data_File_)

- è¦ªãƒ•ã‚©ãƒ«ãƒ€ã® ID è¦å®šå€¤ã¯ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã€‚

```fsharp
let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Name <- "ãƒ•ã‚©ãƒ«ãƒ€å"
metadata.MimeType <- "application/vnd.google-apps.folder"
metadata.Parents <- [|"è¦ªãƒ•ã‚©ãƒ«ãƒ€ã® ID"|]

let createRequest = driveService.Files.Create(metadata)
createRequest.Execute() |> ignore
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

- [Files.Create [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Create_Google_Apis_Drive_v3_Data_File_System_IO_Stream_System_String_)

- è¦ªãƒ•ã‚©ãƒ«ãƒ€ã® ID è¦å®šå€¤ã¯ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã€‚

:::message
é–¢æ•° `GetMimeMapping` ã®å®šç¾©ã¯ [ä¸‹éƒ¨ã«è¨˜è¼‰](#è£œè¶³%3A-.net-5-ã§ã®-mime-ã‚¿ã‚¤ãƒ—ã®å–å¾—)ã€‚
:::

```fsharp
let filePath = @"ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"

let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Name <- System.IO.Path.GetFileName filePath
metadata.Parents <- [|"è¦ªãƒ•ã‚©ãƒ«ãƒ€ã® ID"|]

let fileStream = new System.IO.FileStream(filePath, System.IO.FileMode.Open)
let createMediaUpload = driveService.Files.Create(metadata, fileStream, GetMimeMapping filePath)
createMediaUpload.Upload() |> ignore
fileStream.Dispose()
```

### -- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã® ID ã‚’å–å¾—

æ˜ç¤ºçš„ã« ID ã‚’ç”Ÿæˆã™ã‚‹ã€‚

- [Files.GenerateIds [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_GenerateIds)

```fsharp
let generateIdsRequest = driveService.Files.GenerateIds()
generateIdsRequest.Count <- 1
let id = generateIdsRequest.Execute().Ids.[0]

let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Id <- id
// ...
let iUploadProgress = createMediaUpload.Upload()
if iUploadProgress.Status = Google.Apis.Upload.UploadStatus.Failed then
    raise iUploadProgress.Exception
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

- [Files.Get [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Get_System_String_)

```fsharp
let getRequest = driveService.Files.Get "ãƒ•ã‚¡ã‚¤ãƒ«ã® ID"
let filePath = System.IO.Path.Combine(@"ä¿å­˜å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹", "ãƒ•ã‚¡ã‚¤ãƒ«å")

let fileStream = new System.IO.FileStream(filePath, System.IO.FileMode.Create, System.IO.FileAccess.Write)
getRequest.Download(fileStream)
fileStream.Dispose()
```

## åå‰ã®å¤‰æ›´

- [Files.Update [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Update_Google_Apis_Drive_v3_Data_File_System_String_)

```fsharp
let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Name <- "æ–°ã—ã„åå‰"
let UpdateRequest = driveService.Files.Update(metadata, "å¯¾è±¡ã® ID")
UpdateRequest.Execute() |> ignore
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

- [Files.Update [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Update_Google_Apis_Drive_v3_Data_File_System_String_System_IO_Stream_System_String_)

:::message
é–¢æ•° `GetMimeMapping` ã®å®šç¾©ã¯ [ä¸‹éƒ¨ã«è¨˜è¼‰](#è£œè¶³%3A-.net-5-ã§ã®-mime-ã‚¿ã‚¤ãƒ—ã®å–å¾—)ã€‚
:::

```fsharp
let filePath = @"ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"

let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Name <- System.IO.Path.GetFileName filePath
let mimeMapping = GetMimeMapping filePath
metadata.MimeType <- mimeMapping

let fileStream = new System.IO.FileStream(filePath, System.IO.FileMode.Open)
let updateMediaUpload = driveService.Files.Update(metadata, "ãƒ•ã‚¡ã‚¤ãƒ«ã® ID", fileStream, mimeMapping)
updateMediaUpload.Upload() |> ignore
fileStream.Dispose()
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã®è¤‡è£½

- [Files.Copy [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Copy_Google_Apis_Drive_v3_Data_File_System_String_)

- ä½œæˆä½ç½®ã®è¦å®šå€¤ã¯ã‚³ãƒ”ãƒ¼å…ƒã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã€‚

```fsharp
let metadata = new Google.Apis.Drive.v3.Data.File()
metadata.Parents <- [|"è¦ªãƒ•ã‚©ãƒ«ãƒ€ã® ID"|]
let copyRequest = driveService.Files.Copy(metadata, "ãƒ•ã‚¡ã‚¤ãƒ«ã® ID")
let itemData = copyRequest.Execute()
```

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã®ç§»å‹•

- [Files.Update [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Update_Google_Apis_Drive_v3_Data_File_System_String_)

```fsharp
let metadata = new Google.Apis.Drive.v3.Data.File()
let updateRequest = driveService.Files.Update(metadata, "å¯¾è±¡ã® ID")
updateRequest.AddParents <- "ç§»å‹•å‰ã®ãƒ•ã‚©ãƒ«ãƒ€ã® ID"
updateRequest.RemoveParents <- "ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã® ID"
updateRequest.Execute() |> ignore
```

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã®å‰Šé™¤

- [Files.Delete [â†—]](https://googleapis.dev/dotnet/Google.Apis.Drive.v3/latest/api/Google.Apis.Drive.v3.FilesResource.html#Google_Apis_Drive_v3_FilesResource_Delete_System_String_)

```fsharp
let deleteRequest = driveService.Files.Delete("å¯¾è±¡ã® ID")
deleteRequest.Execute() |> ignore
```

# è£œè¶³: .NET 5 ã§ã® MIME ã‚¿ã‚¤ãƒ—ã®å–å¾—

## é–¢é€£é …ç›®

- [ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰](#ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
- [ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°](#ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°)

## è¨˜è¿°æ™‚ç‚¹ã§ã®ãƒ¡ã‚½ãƒƒãƒ‰å¯¾å¿œçŠ¶æ³

|åˆ©ç”¨|ãƒ¡ã‚½ãƒƒãƒ‰|
|:-:|:-:|
|Ã—|`System.Web.MimeMapping.GetMimeMapping`|
|â–³|`Microsoft.Win32.Registry.ClassesRoot.OpenSubKey`|

`Microsoft.Win32.Registry` ã¯ [NuGet ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ [â†—]](https://www.nuget.org/packages/Microsoft.Win32.Registry/) ã®ã§ãã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚

## å®Ÿè£…

```powershell
dotnet add package Microsoft.Win32.Registry
```

```fsharp
let GetMimeMapping (filePath: string) =
    let mutable mimeMapping = "application/octet-stream"
    let ext = System.IO.Path.GetExtension(filePath).ToLower()
    let registryKey = Microsoft.Win32.Registry.ClassesRoot.OpenSubKey ext

    if registryKey <> null then
        let mimeType = registryKey.GetValue "Content Type"
        if mimeType <> null then
            mimeMapping <- mimeType.ToString()

    mimeMapping
```

# end