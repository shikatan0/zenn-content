---
title: "ã€F#ã€‘Google Drive API ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
emoji: "ğŸ‘¾"
type: "tech"
topics: ["fsharp", "googledrive"]
published: true
---

# å‰æ

å¿œç­”: [System.Net.Http.HttpResponseMessage [â†—]](https://docs.microsoft.com/ja-jp/dotnet/api/system.net.http.httpresponsemessage)

# æˆåŠŸã‹åˆ¤å®šã™ã‚‹

## 200-299

copy, create, export, generateIds, get, list, update, watch.

```fsharp
å¿œç­”.IsSuccessStatusCode
```

## 204

delete[^1], emptyTrash[^2].

[^1]: https://developers.google.com/drive/api/v3/reference/files/delete#response
[^2]: https://developers.google.com/drive/api/v3/reference/files/emptyTrash#response

```fsharp
å¿œç­”.StatusCode = System.Net.HttpStatusCode.NoContent
```

# å‡¦ç†ãŒå¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‹åˆ¤å®šã™ã‚‹[^3]

[^3]: https://developers.google.com/drive/api/v3/handle-errors

## 401 (åˆå›) [^4]

[^4]: https://developers.google.com/drive/api/v3/handle-errors#resolve_a_401_error_invalid_credentials

ç„¡åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€‚

```fsharp
å¿œç­”.StatusCode = System.Net.HttpStatusCode.Unauthorized
```

## 429[^5], 500, 502, 503, 504[^6]

[^5]: https://developers.google.com/drive/api/v3/handle-errors#resolve_a_429_error_too_many_requests
[^6]: https://developers.google.com/drive/api/v3/handle-errors#resolve_a_500_error_backend_error

æ™‚é–“ã‚’ç½®ã‘ã°è§£æ±ºã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‚¨ãƒ©ãƒ¼ã€‚

```fsharp
let retryCodes =
    Set [
        System.Net.HttpStatusCode.TooManyRequests      // 429
        System.Net.HttpStatusCode.InternalServerError  // 500
        System.Net.HttpStatusCode.BadGateway           // 502
        System.Net.HttpStatusCode.ServiceUnavailable   // 503
        System.Net.HttpStatusCode.GatewayTimeout       // 504
    ]

retryCodes |> Set.contains å¿œç­”.StatusCode
```

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…ä¾‹

## æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•[^7]

[^7]: https://cloud.google.com/storage/docs/retry-strategy

```fsharp
let randomNumberGenerator = System.Random()

let Backoff (retryCount: int) =
    let currentWaitMilliseconds =
        min
        <| (2. ** float retryCount) * 1000.
        <| 32000.
    let jitterMilliseconds = int currentWaitMilliseconds + randomNumberGenerator.Next(1, 1001)
    System.Threading.Tasks.Task.Delay(jitterMilliseconds).Wait()
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰

```fsharp
let rec TryXX (retryCount: int) =
    match ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†() with
    | r when r.IsSuccessStatusCode -> æˆåŠŸæ™‚ã®å‡¦ç†
    | r when r.StatusCode = System.Net.HttpStatusCode.Unauthorized ->
        match retryCount with
        | 0 -> refresh()
        | _ -> failwith "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°å‡¦ç†ã®ã‚¨ãƒ©ãƒ¼"
    | r when retryCodes |> Set.contains r.StatusCode -> backoff retryCount
    | _ -> failwith "æœªå®šç¾©ãªã‚¨ãƒ©ãƒ¼"
and refresh () =
    ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°å‡¦ç†
    TryXX 1
and backoff (retryCount: int) =
    match retryCount with
    | è©¦è¡Œå›æ•°ã®ä¸Šé™ -> failwith "è©¦è¡Œå›æ•°ã®ä¸Šé™"
    | _ -> Backoff retryCount
    TryXX (retryCount + 1)

// ...

TryXX 0
```

# end
